import pandas as pd

PROGRAMAS = ['adultos_mayores', 'discapacidad', 'madres_trabajadoras']

CALENDARIOS_EXACTOS = {
    '2023-11': [
        ('2023-11-06', ['A']),
        ('2023-11-07', ['B']),
        ('2023-11-08', ['C']),
        ('2023-11-09', ['C']),
        ('2023-11-10', ['D', 'E', 'F']),
        ('2023-11-13', ['G']),
        ('2023-11-14', ['G']),
        ('2023-11-15', ['H', 'I', 'J', 'K']),
        ('2023-11-16', ['L']),
        ('2023-11-17', ['M']),
        ('2023-11-21', ['M']),
        ('2023-11-22', ['N', 'Ñ', 'O']),
        ('2023-11-23', ['P', 'Q']),
        ('2023-11-24', ['R']),
        ('2023-11-27', ['R']),
        ('2023-11-28', ['S']),
        ('2023-11-29', ['T', 'U']),
        ('2023-11-30', ['V', 'W', 'X', 'Y', 'Z']),
    ],
    '2024-01-electoral': [
        ('2024-01-29', ['A']),
        ('2024-01-30', ['B']),
        ('2024-01-31', ['C']),
        ('2024-02-01', ['C']),
        ('2024-02-02', ['D', 'E', 'F']),
        ('2024-02-06', ['G']),
        ('2024-02-07', ['G']),
        ('2024-02-08', ['H']),
        ('2024-02-09', ['I', 'J', 'K']),
        ('2024-02-12', ['L']),
        ('2024-02-13', ['M']),
        ('2024-02-14', ['M']),
        ('2024-02-15', ['N', 'Ñ', 'O']),
        ('2024-02-16', ['P', 'Q']),
        ('2024-02-19', ['R']),
        ('2024-02-20', ['R']),
        ('2024-02-21', ['S']),
        ('2024-02-22', ['T', 'U']),
        ('2024-02-23', ['V', 'W', 'X', 'Y', 'Z']),
    ],
    '2024-07': [
        ('2024-07-01', ['A']),
        ('2024-07-02', ['B']),
        ('2024-07-03', ['C']),
        ('2024-07-04', ['C']),
        ('2024-07-05', ['D', 'E', 'F']),
        ('2024-07-08', ['G']),
        ('2024-07-09', ['G']),
        ('2024-07-10', ['H', 'I', 'J', 'K']),
        ('2024-07-11', ['L']),
        ('2024-07-12', ['M']),
        ('2024-07-15', ['M']),
        ('2024-07-16', ['N', 'Ñ', 'O']),
        ('2024-07-17', ['P', 'Q']),
        ('2024-07-18', ['R']),
        ('2024-07-19', ['R']),
        ('2024-07-22', ['S', 'T', 'U', 'V', 'W', 'X', 'Y', 'Z']),
    ],
    '2024-09': [
        ('2024-09-02', ['A']),
        ('2024-09-03', ['B']),
        ('2024-09-04', ['C']),
        ('2024-09-05', ['C']),
        ('2024-09-06', ['D', 'E', 'F']),
        ('2024-09-09', ['G']),
        ('2024-09-10', ['G']),
        ('2024-09-11', ['H', 'I', 'J', 'K']),
        ('2024-09-12', ['L']),
        ('2024-09-13', ['M']),
        ('2024-09-17', ['M']),
        ('2024-09-18', ['N', 'Ñ', 'O']),
        ('2024-09-19', ['P', 'Q']),
        ('2024-09-20', ['R', 'S', 'T', 'U', 'V', 'W', 'X', 'Y', 'Z']),
    ],
    '2024-11': [
        ('2024-11-04', ['A']),
        ('2024-11-05', ['B']),
        ('2024-11-06', ['C']),
        ('2024-11-07', ['C']),
        ('2024-11-08', ['D', 'E', 'F']),
        ('2024-11-11', ['G']),
        ('2024-11-12', ['G']),
        ('2024-11-13', ['H', 'I', 'J', 'K']),
        ('2024-11-14', ['L']),
        ('2024-11-15', ['M']),
        ('2024-11-19', ['M']),
        ('2024-11-20', ['N', 'Ñ', 'O']),
        ('2024-11-21', ['P', 'Q']),
        ('2024-11-22', ['R']),
        ('2024-11-25', ['R']),
        ('2024-11-26', ['S']),
        ('2024-11-27', ['T', 'U', 'V']),
        ('2024-11-28', ['W', 'X', 'Y', 'Z']),
    ],
    '2025-01': [
        ('2025-01-02', ['A']),
        ('2025-01-03', ['B']),
        ('2025-01-06', ['C']),
        ('2025-01-07', ['C']),
        ('2025-01-08', ['D', 'E', 'F']),
        ('2025-01-09', ['G']),
        ('2025-01-10', ['G']),
        ('2025-01-13', ['H', 'I', 'J', 'K']),
        ('2025-01-14', ['L']),
        ('2025-01-15', ['M']),
        ('2025-01-16', ['M']),
        ('2025-01-17', ['N', 'Ñ', 'O']),
        ('2025-01-20', ['P', 'Q']),
        ('2025-01-21', ['R']),
        ('2025-01-22', ['S', 'T', 'U', 'V', 'W', 'X', 'Y', 'Z']),
    ],
    '2025-03': [
        ('2025-03-03', ['A']),
        ('2025-03-04', ['B']),
        ('2025-03-05', ['C']),
        ('2025-03-06', ['C']),
        ('2025-03-07', ['D', 'E', 'F']),
        ('2025-03-10', ['G']),
        ('2025-03-11', ['G']),
        ('2025-03-12', ['H', 'I', 'J', 'K']),
        ('2025-03-13', ['L']),
        ('2025-03-14', ['M']),
        ('2025-03-17', ['M']),
        ('2025-03-18', ['N', 'Ñ', 'O']),
        ('2025-03-19', ['P', 'Q']),
        ('2025-03-20', ['R']),
        ('2025-03-24', ['R']),
        ('2025-03-25', ['S']),
        ('2025-03-26', ['T', 'U', 'V']),
        ('2025-03-27', ['W', 'X', 'Y', 'Z']),
    ],
    '2025-05': [
        ('2025-05-07', ['A']),
        ('2025-05-08', ['B']),
        ('2025-05-09', ['C']),
        ('2025-05-12', ['C']),
        ('2025-05-13', ['D', 'E', 'F']),
        ('2025-05-14', ['G']),
        ('2025-05-15', ['G']),
        ('2025-05-16', ['H', 'I', 'J', 'K']),
        ('2025-05-19', ['L']),
        ('2025-05-20', ['M']),
        ('2025-05-21', ['M']),
        ('2025-05-22', ['N', 'Ñ', 'O']),
        ('2025-05-23', ['P', 'Q']),
        ('2025-05-26', ['R']),
        ('2025-05-27', ['R']),
        ('2025-05-28', ['S']),
        ('2025-05-29', ['T', 'U', 'V']),
        ('2025-05-30', ['W', 'X', 'Y', 'Z']),
    ],
    '2025-07': [
        ('2025-07-01', ['A']),
        ('2025-07-02', ['B']),
        ('2025-07-03', ['C']),
        ('2025-07-04', ['C']),
        ('2025-07-07', ['D', 'E', 'F']),
        ('2025-07-08', ['G']),
        ('2025-07-09', ['G']),
        ('2025-07-10', ['H', 'I', 'J', 'K']),
        ('2025-07-11', ['L']),
        ('2025-07-14', ['M']),
        ('2025-07-15', ['M']),
        ('2025-07-16', ['N', 'Ñ', 'O']),
        ('2025-07-17', ['P', 'Q']),
        ('2025-07-18', ['R']),
        ('2025-07-21', ['R']),
        ('2025-07-22', ['S']),
        ('2025-07-23', ['T', 'U', 'V']),
        ('2025-07-24', ['W', 'X', 'Y', 'Z']),
    ],
    '2025-09': [
        ('2025-09-02', ['A']),
        ('2025-09-03', ['B']),
        ('2025-09-04', ['C']),
        ('2025-09-05', ['C']),
        ('2025-09-08', ['D', 'E', 'F']),
        ('2025-09-09', ['G']),
        ('2025-09-10', ['G']),
        ('2025-09-11', ['H', 'I', 'J', 'K']),
        ('2025-09-12', ['L']),
        ('2025-09-15', ['M']),
        ('2025-09-16', ['M']),
        ('2025-09-17', ['N', 'Ñ', 'O']),
        ('2025-09-18', ['P', 'Q']),
        ('2025-09-19', ['R']),
        ('2025-09-22', ['R', 'S', 'T', 'U', 'V', 'W', 'X', 'Y', 'Z']),
    ],
    '2025-11': [
        ('2025-11-04', ['A']),
        ('2025-11-05', ['B']),
        ('2025-11-06', ['C']),
        ('2025-11-07', ['C']),
        ('2025-11-10', ['D', 'E', 'F']),
        ('2025-11-11', ['G']),
        ('2025-11-12', ['G']),
        ('2025-11-13', ['H', 'I', 'J', 'K']),
        ('2025-11-14', ['L']),
        ('2025-11-17', ['M']),
        ('2025-11-18', ['M']),
        ('2025-11-19', ['N', 'Ñ', 'O']),
        ('2025-11-20', ['P', 'Q']),
        ('2025-11-21', ['R']),
        ('2025-11-24', ['R']),
        ('2025-11-25', ['S']),
        ('2025-11-26', ['T', 'U', 'V']),
        ('2025-11-28', ['W', 'X', 'Y', 'Z']),
    ],
    '2026-01': [
        ('2026-01-05', ['A']),
        ('2026-01-06', ['B']),
        ('2026-01-07', ['C']),
        ('2026-01-08', ['C']),
        ('2026-01-09', ['D', 'E', 'F']),
        ('2026-01-12', ['G']),
        ('2026-01-13', ['G']),
        ('2026-01-14', ['H', 'I', 'J', 'K']),
        ('2026-01-15', ['L']),
        ('2026-01-16', ['M']),
        ('2026-01-19', ['M']),
        ('2026-01-20', ['N', 'Ñ', 'O']),
        ('2026-01-21', ['P', 'Q']),
        ('2026-01-22', ['R']),
        ('2026-01-23', ['R']),
        ('2026-01-26', ['S']),
        ('2026-01-27', ['T', 'U', 'V']),
        ('2026-01-28', ['W', 'X', 'Y', 'Z']),
    ],
}


def construir_fechas_por_evento():
    """
    Devuelve dict {nombre_evento: set_de_fechas_con_ventana_incluida}.
    Incluye la ventana de efecto de 3 días posteriores al evento.
    """
    fechas_por_evento = {}

    for periodo, dias in CALENDARIOS_EXACTOS.items():
        for fecha_str, letras in dias:
            fecha_base = pd.Timestamp(fecha_str)
            for programa in PROGRAMAS:
                for letra in letras:
                    nombre = f"{programa}_{letra}"
                    if nombre not in fechas_por_evento:
                        fechas_por_evento[nombre] = set()
                    # Día del evento + 3 días de ventana posterior
                    for offset in range(4):
                        fechas_por_evento[nombre].add(fecha_base + pd.Timedelta(days=offset))

    return fechas_por_evento


# Se construye una sola vez al importar el módulo (es constante)
_FECHAS_POR_EVENTO = construir_fechas_por_evento()


def agregar_columnas_eventos(df):
    """
    Añade a df las columnas binarias de eventos que el modelo espera.
    df debe tener columna 'ds' de tipo datetime.
    Retorna una copia de df con las columnas de eventos añadidas.
    """
    df = df.copy()
    ds_series = pd.to_datetime(df["ds"])

    for nombre_evento, fechas in _FECHAS_POR_EVENTO.items():
        df[nombre_evento] = ds_series.isin(fechas).astype(int)

    return df


def obtener_nombres_eventos():
    """Devuelve la lista ordenada de nombres de eventos (columnas)."""
    return sorted(_FECHAS_POR_EVENTO.keys())
